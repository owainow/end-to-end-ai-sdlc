<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather App</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Weather Icons CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/weather-icons/2.0.12/css/weather-icons.min.css">
    
    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#6B7280',
                    }
                }
            }
        }
    </script>
    
    <style>
        /* Custom animations and styles */
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Weather icon sizing */
        .weather-icon-large {
            font-size: 4rem;
        }
        
        @media (min-width: 768px) {
            .weather-icon-large {
                font-size: 5rem;
            }
        }
        
        /* FAQ accordion styles (T009) */
        details summary {
            cursor: pointer;
            user-select: none;
        }
        
        details summary::-webkit-details-marker {
            display: none;
        }
        
        details summary::before {
            content: 'â€º';
            display: inline-block;
            transition: transform 0.2s ease;
            font-size: 1.5rem;
            margin-right: 0.5rem;
            color: #3B82F6;
        }
        
        details[open] summary::before {
            transform: rotate(90deg);
        }
        
        details summary:hover {
            background-color: #F3F4F6;
        }
        
        /* Smooth height transition for FAQ answers */
        details[open] .faq-answer {
            animation: slideDown 0.2s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Weather Background Styles - Dynamic Weather Background Feature */
        #weather-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
            pointer-events: none;
            overflow: hidden;
            transition: opacity 0.5s ease-in-out;
        }
        
        #weather-background.hidden {
            opacity: 0;
            visibility: hidden;
        }
        
        #rain-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .rain-drop {
            position: absolute;
            width: 2px;
            height: 20px;
            background: linear-gradient(to bottom, rgba(174, 194, 224, 0.1), rgba(174, 194, 224, 0.8));
            animation: fall linear infinite;
            will-change: transform;
        }
        
        @keyframes fall {
            from {
                transform: translateY(-100px);
            }
            to {
                transform: translateY(100vh);
            }
        }
        
        /* Fade transitions for background */
        .background-fade-in {
            animation: backgroundFadeIn 0.5s ease-in-out forwards;
        }
        
        .background-fade-out {
            animation: backgroundFadeOut 0.5s ease-in-out forwards;
        }
        
        @keyframes backgroundFadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes backgroundFadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
        
        /* Respect prefers-reduced-motion */
        @media (prefers-reduced-motion: reduce) {
            .rain-drop {
                animation: none;
            }
            
            #weather-background {
                transition: none;
            }
        }
        
        /* Ensure container has proper z-index */
        .container {
            position: relative;
            z-index: 10;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Weather Background Container -->
    <div id="weather-background" class="hidden">
        <div id="rain-container"></div>
    </div>
    
    <div class="container mx-auto px-4 py-8 max-w-lg">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">
                <i class="wi wi-day-sunny text-yellow-500 mr-2"></i>
                Weather App
            </h1>
            
            <!-- Unit Toggle -->
            <div class="inline-flex gap-2 items-center">
                <div class="inline-flex rounded-lg border border-gray-300 bg-white shadow-sm" role="group" aria-label="Temperature unit selection">
                    <button 
                        id="unit-metric" 
                        type="button"
                        class="px-4 py-2 text-sm font-medium rounded-l-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                        aria-pressed="true"
                    >
                        Â°C
                    </button>
                    <button 
                        id="unit-imperial" 
                        type="button"
                        class="px-4 py-2 text-sm font-medium rounded-r-lg transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
                        aria-pressed="false"
                    >
                        Â°F
                    </button>
                </div>
                
                <!-- Help Button (T001) -->
                <button 
                    id="help-btn" 
                    type="button"
                    class="px-4 py-2 text-sm font-medium rounded-lg border border-gray-300 bg-white hover:bg-blue-50 text-gray-700 hover:text-blue-600 transition-all duration-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 min-w-[44px] min-h-[44px] flex items-center justify-center"
                    aria-label="Open help page"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </button>
            </div>
        </header>
        
        <!-- Weather View (T002) -->
        <div id="weather-view">
        
        <!-- Search Section -->
        <section class="mb-8" aria-label="City search">
            <form id="search-form" class="flex gap-2">
                <label for="city-search" class="sr-only">Enter city name</label>
                <input 
                    type="text" 
                    id="city-search" 
                    name="city"
                    placeholder="Enter city name..."
                    autocomplete="off"
                    class="flex-1 px-4 py-3 text-lg border-2 border-gray-200 rounded-lg 
                           focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none 
                           transition-colors bg-white"
                    aria-describedby="search-hint"
                >
                <!-- Geolocation Button (T005) -->
                <button 
                    type="button" 
                    id="location-btn"
                    class="px-4 py-3 bg-green-500 hover:bg-green-600 disabled:bg-gray-300 
                           text-white font-medium rounded-lg transition-colors
                           focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2
                           flex items-center justify-center min-w-[44px] min-h-[44px]"
                    aria-label="Use my location"
                    title="Use my location"
                >
                    <!-- Location icon (T005) - Crosshair/target icon -->
                    <svg id="location-btn-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2v4m0 12v4M2 12h4m12 0h4m-7 0a5 5 0 11-10 0 5 5 0 0110 0z" />
                    </svg>
                    <!-- Loading spinner (T006) - hidden by default -->
                    <svg id="location-btn-spinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
                <button 
                    type="submit" 
                    id="search-btn"
                    class="px-6 py-3 bg-blue-500 hover:bg-blue-600 disabled:bg-blue-300 
                           text-white font-medium rounded-lg transition-colors
                           focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
                           flex items-center justify-center min-w-[100px]"
                >
                    <span id="search-btn-text">Search</span>
                    <!-- Loading spinner for button (hidden by default) -->
                    <svg id="search-btn-spinner" class="hidden animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </button>
            </form>
            <span id="search-hint" class="sr-only">Press Enter or click Search to find weather</span>
            
            <!-- Validation Message -->
            <p id="validation-message" class="hidden mt-2 text-sm text-red-600" role="alert"></p>
        </section>
        
        <!-- Content Area -->
        <main id="content-area">
            
            <!-- Welcome Message (initial state) -->
            <div id="welcome-message" class="text-center py-12 text-gray-500">
                <i class="wi wi-day-cloudy text-6xl text-gray-300 mb-4 block"></i>
                <p class="text-lg">Enter a city name to see the weather</p>
            </div>
            
            <!-- Loading Spinner -->
            <div id="loading-spinner" class="hidden py-12">
                <div class="flex flex-col items-center justify-center">
                    <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-500 border-t-transparent mb-4"></div>
                    <p class="text-gray-500">Fetching weather data...</p>
                </div>
            </div>
            
            <!-- Error Container -->
            <div id="error-container" class="hidden fade-in">
                <div class="bg-red-50 border border-red-200 rounded-xl p-6">
                    <div class="flex items-start">
                        <svg class="h-6 w-6 text-red-500 mr-3 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <div>
                            <h3 class="text-red-800 font-medium">Unable to get weather</h3>
                            <p id="error-message" class="text-red-700 mt-1"></p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Weather Card -->
            <div id="weather-card" class="hidden fade-in">
                <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
                    
                    <!-- Location Header -->
                    <div class="text-center mb-6">
                        <h2 id="city-name" class="text-2xl md:text-3xl font-semibold text-gray-800"></h2>
                    </div>
                    
                    <!-- Main Weather Display -->
                    <div class="flex items-center justify-center gap-4 mb-6">
                        <i id="weather-icon" class="weather-icon-large text-blue-500" aria-hidden="true"></i>
                        <div class="text-center">
                            <span id="temperature" class="text-5xl md:text-7xl font-bold text-gray-800"></span>
                        </div>
                    </div>
                    
                    <!-- Feels Like -->
                    <p id="feels-like" class="text-center text-gray-500 mb-6"></p>
                    
                    <!-- Stats Grid -->
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <!-- Humidity -->
                        <div class="bg-blue-50 rounded-xl p-4 text-center">
                            <i class="wi wi-humidity text-blue-400 text-3xl mb-2" aria-hidden="true"></i>
                            <p id="humidity" class="text-xl font-semibold text-gray-800"></p>
                            <p class="text-sm text-gray-500">Humidity</p>
                        </div>
                        
                        <!-- Wind -->
                        <div class="bg-gray-50 rounded-xl p-4 text-center">
                            <i class="wi wi-strong-wind text-gray-400 text-3xl mb-2" aria-hidden="true"></i>
                            <p id="wind-speed" class="text-xl font-semibold text-gray-800"></p>
                            <p class="text-sm text-gray-500">Wind</p>
                        </div>
                    </div>
                    
                    <!-- Weather Description -->
                    <p id="description" class="text-center text-xl text-gray-600 capitalize"></p>
                    
                </div>
            </div>
            
        </main>
        
        </div><!-- End Weather View -->
        
        <!-- Help View (T003) -->
        <div id="help-view" class="hidden">
            
            <!-- Back Navigation (T004) -->
            <div class="mb-6">
                <button 
                    id="back-to-weather-btn" 
                    type="button"
                    class="px-4 py-2 text-sm font-medium rounded-lg bg-white hover:bg-gray-50 text-gray-700 transition-colors duration-200 border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 flex items-center gap-2"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    Back to Weather
                </button>
            </div>
            
            <!-- Help Page Header -->
            <div class="text-center mb-8">
                <h2 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">Help & FAQ</h2>
                <p class="text-gray-600">Everything you need to know about using the Weather App</p>
            </div>
            
            <!-- Quick Tips Section (T005) -->
            <section class="mb-12" aria-label="Quick tips">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Quick Tips</h3>
                <div id="quick-tips-container" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Quick tips will be rendered here by JavaScript -->
                </div>
            </section>
            
            <!-- FAQ Section (T006) -->
            <section aria-label="Frequently asked questions">
                <h3 class="text-2xl font-semibold text-gray-800 mb-6">Frequently Asked Questions</h3>
                <div id="faq-container" class="space-y-8">
                    <!-- FAQ items will be rendered here by JavaScript -->
                </div>
            </section>
            
        </div><!-- End Help View -->
        
        <!-- Footer -->
        <footer class="mt-12 text-center text-sm text-gray-400">
            <p>Powered by OpenWeatherMap</p>
        </footer>
        
    </div>

    <!-- JavaScript -->
    <script>
        // ============================================
        // State Management
        // ============================================
        const state = {
            city: '',
            weather: null,
            units: 'metric',
            loading: false,
            error: null,
            currentView: 'weather', // T010: track current view
            geolocating: false, // T006: track geolocation state
            backgroundEffect: null // T005: track current background effect
        };

        // ============================================
        // Constants
        // ============================================
        const STORAGE_KEYS = {
            UNITS: 'weatherUnits'
        };
        
        // Rain animation constants
        const RAIN_CONFIG = {
            DROP_COUNT: 75,
            MIN_DURATION: 0.5,  // seconds
            MAX_DURATION: 1.5,  // seconds
            MAX_DELAY: 2        // seconds
        };
        
        // Quick Tips Data (T015)
        const QUICK_TIPS = [
            {
                id: 'tip-search',
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                </svg>`,
                title: 'Search for Cities',
                description: 'Enter any city name to get instant weather information. Try major cities or your hometown!'
            },
            {
                id: 'tip-units',
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                </svg>`,
                title: 'Toggle Units',
                description: 'Switch between Celsius (Â°C) and Fahrenheit (Â°F) using the toggle buttons above.'
            },
            {
                id: 'tip-specific',
                icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>`,
                title: 'Be Specific',
                description: 'For cities with common names, try adding the country code (e.g., "Paris, FR" or "London, UK").'
            }
        ];
        
        // FAQ Data (T015)
        const FAQ_DATA = [
            {
                id: 'getting-started',
                title: 'Getting Started',
                icon: 'ðŸš€',
                items: [
                    {
                        id: 'faq-how-to-use',
                        question: 'How do I use the Weather App?',
                        answer: 'Simply enter a city name in the search box and click "Search" or press Enter. The app will display current weather conditions including temperature, humidity, wind speed, and more.'
                    },
                    {
                        id: 'faq-geolocation',
                        question: 'How do I use my current location?',
                        answer: 'Click the green location button next to the search box. Your browser will ask for permission to access your location. Once granted, the app will automatically fetch weather data for your current location. Note: Location services must be enabled on your device and browser for this feature to work.'
                    },
                    {
                        id: 'faq-units',
                        question: 'How do I change temperature units?',
                        answer: 'Use the toggle buttons (Â°C / Â°F) at the top of the page. Your preference is saved automatically and will be remembered on your next visit.'
                    },
                    {
                        id: 'faq-city-not-found',
                        question: 'What if my city is not found?',
                        answer: 'Make sure the city name is spelled correctly. For cities with common names, try adding a country code (e.g., "Springfield, US" or "Cambridge, UK"). You can also try nearby larger cities.'
                    }
                ]
            },
            {
                id: 'weather-data',
                title: 'Weather Data',
                icon: 'ðŸŒ¤ï¸',
                items: [
                    {
                        id: 'faq-data-source',
                        question: 'Where does the weather data come from?',
                        answer: 'All weather data is provided by OpenWeatherMap, a reliable weather data service that collects information from thousands of weather stations, satellites, and weather models worldwide.'
                    },
                    {
                        id: 'faq-update-frequency',
                        question: 'How often is weather data updated?',
                        answer: 'Weather data is cached for 15 minutes to provide fast loading times while ensuring reasonably current information. The data from OpenWeatherMap is updated every 10 minutes from their sources.'
                    },
                    {
                        id: 'faq-accuracy',
                        question: 'How accurate is the weather information?',
                        answer: 'OpenWeatherMap provides professional-grade weather data with high accuracy. However, weather conditions can change rapidly, and forecasts may vary. Always check official weather services for severe weather warnings.'
                    }
                ]
            },
            {
                id: 'troubleshooting',
                title: 'Troubleshooting',
                icon: 'ðŸ”§',
                items: [
                    {
                        id: 'faq-not-loading',
                        question: 'Why is the weather data not loading?',
                        answer: 'Check your internet connection first. If the problem persists, the weather service might be temporarily unavailable. Try refreshing the page or waiting a few minutes before searching again.'
                    },
                    {
                        id: 'faq-wrong-location',
                        question: 'The app shows the wrong location for my city',
                        answer: 'Some city names exist in multiple countries. Try being more specific by adding the state or country (e.g., "Portland, OR" or "Portland, ME"). You can also try using the full official name of your city.'
                    },
                    {
                        id: 'faq-slow',
                        question: 'Why is the app loading slowly?',
                        answer: 'Initial searches may take a few seconds while fetching data from the weather service. Subsequent searches for the same city within 15 minutes will be faster due to caching. Slow internet connections can also affect loading times.'
                    }
                ]
            },
            {
                id: 'privacy',
                title: 'Privacy & Data',
                icon: 'ðŸ”’',
                items: [
                    {
                        id: 'faq-data-collection',
                        question: 'Does the app collect my personal data?',
                        answer: 'The Weather App only stores your temperature unit preference (Â°C or Â°F) in your browser\'s local storage. We do not collect, store, or transmit any personal information. No login or account is required.'
                    },
                    {
                        id: 'faq-location-tracking',
                        question: 'Does the app track my location?',
                        answer: 'The app only uses geolocation when you explicitly click the location button and grant permission. Your location is used once to fetch weather data and is not stored, tracked, or transmitted anywhere else. You have full control and can deny permission at any time.'
                    },
                    {
                        id: 'faq-cookies',
                        question: 'Does the app use cookies?',
                        answer: 'The app does not use cookies. Your temperature unit preference is stored using browser localStorage, which stays on your device and is not transmitted to any server.'
                    }
                ]
            }
        ];

        // OpenWeatherMap icon code to Weather Icons class mapping
        const WEATHER_ICON_MAP = {
            // Clear
            '01d': 'wi-day-sunny',
            '01n': 'wi-night-clear',
            // Few clouds
            '02d': 'wi-day-cloudy',
            '02n': 'wi-night-alt-cloudy',
            // Scattered clouds
            '03d': 'wi-cloud',
            '03n': 'wi-cloud',
            // Broken clouds
            '04d': 'wi-cloudy',
            '04n': 'wi-cloudy',
            // Shower rain
            '09d': 'wi-showers',
            '09n': 'wi-showers',
            // Rain
            '10d': 'wi-day-rain',
            '10n': 'wi-night-alt-rain',
            // Thunderstorm
            '11d': 'wi-thunderstorm',
            '11n': 'wi-thunderstorm',
            // Snow
            '13d': 'wi-snow',
            '13n': 'wi-snow',
            // Mist/Fog
            '50d': 'wi-fog',
            '50n': 'wi-fog'
        };

        // Icon colors based on weather type
        const WEATHER_ICON_COLORS = {
            'wi-day-sunny': 'text-yellow-500',
            'wi-night-clear': 'text-indigo-400',
            'wi-day-cloudy': 'text-gray-400',
            'wi-night-alt-cloudy': 'text-gray-500',
            'wi-cloud': 'text-gray-400',
            'wi-cloudy': 'text-gray-500',
            'wi-showers': 'text-blue-400',
            'wi-day-rain': 'text-blue-500',
            'wi-night-alt-rain': 'text-blue-600',
            'wi-thunderstorm': 'text-purple-500',
            'wi-snow': 'text-blue-200',
            'wi-fog': 'text-gray-400'
        };

        // ============================================
        // DOM Elements
        // ============================================
        const elements = {
            // Search
            searchForm: document.getElementById('search-form'),
            cityInput: document.getElementById('city-search'),
            searchBtn: document.getElementById('search-btn'),
            searchBtnText: document.getElementById('search-btn-text'),
            searchBtnSpinner: document.getElementById('search-btn-spinner'),
            validationMessage: document.getElementById('validation-message'),

            // Geolocation button (T010)
            locationBtn: document.getElementById('location-btn'),
            locationBtnIcon: document.getElementById('location-btn-icon'),
            locationBtnSpinner: document.getElementById('location-btn-spinner'),

            // Unit toggle
            unitMetric: document.getElementById('unit-metric'),
            unitImperial: document.getElementById('unit-imperial'),

            // Content areas
            welcomeMessage: document.getElementById('welcome-message'),
            loadingSpinner: document.getElementById('loading-spinner'),
            errorContainer: document.getElementById('error-container'),
            errorMessage: document.getElementById('error-message'),
            weatherCard: document.getElementById('weather-card'),

            // Weather data
            cityName: document.getElementById('city-name'),
            temperature: document.getElementById('temperature'),
            feelsLike: document.getElementById('feels-like'),
            humidity: document.getElementById('humidity'),
            windSpeed: document.getElementById('wind-speed'),
            description: document.getElementById('description'),
            weatherIcon: document.getElementById('weather-icon'),
            
            // View navigation (T010)
            weatherView: document.getElementById('weather-view'),
            helpView: document.getElementById('help-view'),
            helpBtn: document.getElementById('help-btn'),
            backToWeatherBtn: document.getElementById('back-to-weather-btn'),
            
            // Help content containers
            quickTipsContainer: document.getElementById('quick-tips-container'),
            faqContainer: document.getElementById('faq-container'),
            
            // Weather background elements
            weatherBackground: document.getElementById('weather-background'),
            rainContainer: document.getElementById('rain-container')
        };

        // ============================================
        // Utility Functions
        // ============================================
        
        /**
         * Get Weather Icons class for an icon code
         */
        function getWeatherIconClass(iconCode) {
            return WEATHER_ICON_MAP[iconCode] || 'wi-na';
        }

        /**
         * Get icon color class
         */
        function getIconColorClass(iconClass) {
            return WEATHER_ICON_COLORS[iconClass] || 'text-blue-500';
        }

        /**
         * Format temperature with unit
         */
        function formatTemperature(temp, units) {
            const symbol = units === 'metric' ? 'Â°C' : 'Â°F';
            return `${Math.round(temp)}${symbol}`;
        }

        /**
         * Format wind speed with unit
         */
        function formatWindSpeed(speed, units) {
            const unit = units === 'metric' ? 'm/s' : 'mph';
            return `${speed} ${unit}`;
        }

        /**
         * Capitalize first letter of each word
         */
        function capitalizeFirst(str) {
            return str.replace(/\b\w/g, char => char.toUpperCase());
        }
        
        /**
         * Check if user prefers reduced motion
         */
        function prefersReducedMotion() {
            return window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        }
        
        // ============================================
        // Weather Background Functions
        // ============================================
        
        /**
         * Create rain drops for rain animation
         */
        function createRainDrops(count) {
            // Don't create animation if user prefers reduced motion
            if (prefersReducedMotion()) {
                return;
            }
            
            const fragment = document.createDocumentFragment();
            
            for (let i = 0; i < count; i++) {
                const drop = document.createElement('div');
                drop.className = 'rain-drop';
                
                // Random horizontal position
                drop.style.left = Math.random() * 100 + '%';
                
                // Random animation duration
                const durationRange = RAIN_CONFIG.MAX_DURATION - RAIN_CONFIG.MIN_DURATION;
                const duration = RAIN_CONFIG.MIN_DURATION + Math.random() * durationRange;
                drop.style.animationDuration = duration + 's';
                
                // Random animation delay for staggered effect
                drop.style.animationDelay = Math.random() * RAIN_CONFIG.MAX_DELAY + 's';
                
                fragment.appendChild(drop);
            }
            
            elements.rainContainer.appendChild(fragment);
        }
        
        /**
         * Clear all rain drops
         */
        function clearRain() {
            elements.rainContainer.innerHTML = '';
        }
        
        /**
         * Get background effect based on weather description
         */
        function getBackgroundEffect(description) {
            if (!description) return null;
            
            const lowerDesc = description.toLowerCase();
            // Check for rain-related keywords in description
            const rainyKeywords = ['rain', 'drizzle', 'shower'];
            const hasRain = rainyKeywords.some(keyword => lowerDesc.includes(keyword));
            
            return hasRain ? 'rain' : null;
        }
        
        /**
         * Set background effect
         */
        function setBackgroundEffect(effect) {
            // If same effect, do nothing
            if (state.backgroundEffect === effect) {
                return;
            }
            
            // Clear any existing effect
            if (state.backgroundEffect === 'rain') {
                clearRain();
            }
            
            state.backgroundEffect = effect;
            
            if (effect === 'rain') {
                // Show background and create rain
                elements.weatherBackground.classList.remove('hidden');
                createRainDrops(RAIN_CONFIG.DROP_COUNT);
            } else {
                // Hide background
                elements.weatherBackground.classList.add('hidden');
            }
        }
        
        // ============================================
        // View Navigation Functions (T011, T012)
        // ============================================
        
        /**
         * Show the help view and hide weather view
         */
        function showHelpView() {
            elements.weatherView.classList.add('hidden');
            elements.helpView.classList.remove('hidden');
            state.currentView = 'help';
            window.location.hash = 'help';
            
            // Hide background when in help view
            elements.weatherBackground.classList.add('hidden');
            
            // Focus management for accessibility - delay to ensure DOM is ready
            setTimeout(() => {
                elements.backToWeatherBtn.focus();
            }, 0);
        }
        
        /**
         * Show the weather view and hide help view
         */
        function showWeatherView() {
            elements.helpView.classList.add('hidden');
            elements.weatherView.classList.remove('hidden');
            state.currentView = 'weather';
            
            // Restore background if there's an active effect
            if (state.backgroundEffect) {
                elements.weatherBackground.classList.remove('hidden');
            }
            
            // Clear hash without triggering hashchange
            if (window.location.hash) {
                history.pushState('', document.title, window.location.pathname + window.location.search);
            }
            
            // Focus management for accessibility - delay to ensure DOM is ready
            setTimeout(() => {
                elements.cityInput.focus();
            }, 0);
        }
        
        // ============================================
        // Help Content Rendering (T016)
        // ============================================
        
        /**
         * Render a single FAQ item
         */
        function renderFAQItem(item) {
            return `
                <details class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                    <summary class="px-6 py-4 font-medium text-gray-800 transition-colors">
                        ${item.question}
                    </summary>
                    <div class="faq-answer px-6 pb-4 pt-2 text-gray-600 leading-relaxed">
                        ${item.answer}
                    </div>
                </details>
            `;
        }
        
        /**
         * Render a FAQ category with its items
         */
        function renderFAQCategory(category) {
            const itemsHtml = category.items.map(item => renderFAQItem(item)).join('');
            return `
                <div class="faq-category">
                    <h4 class="text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
                        <span class="text-2xl">${category.icon}</span>
                        ${category.title}
                    </h4>
                    <div class="space-y-3">
                        ${itemsHtml}
                    </div>
                </div>
            `;
        }
        
        /**
         * Render all FAQ categories
         */
        function renderFAQ() {
            const categoriesHtml = FAQ_DATA.map(category => renderFAQCategory(category)).join('');
            elements.faqContainer.innerHTML = categoriesHtml;
        }
        
        /**
         * Render quick tips
         */
        function renderQuickTips() {
            const tipsHtml = QUICK_TIPS.map(tip => `
                <div class="bg-blue-50 rounded-xl p-6 text-center hover:shadow-md transition-shadow">
                    <div class="flex justify-center mb-4">
                        ${tip.icon}
                    </div>
                    <h4 class="font-semibold text-gray-800 mb-2">${tip.title}</h4>
                    <p class="text-sm text-gray-600">${tip.description}</p>
                </div>
            `).join('');
            elements.quickTipsContainer.innerHTML = tipsHtml;
        }

        // ============================================
        // localStorage Functions
        // ============================================
        
        function getStoredUnits() {
            return localStorage.getItem(STORAGE_KEYS.UNITS) || 'metric';
        }

        function saveUnits(units) {
            localStorage.setItem(STORAGE_KEYS.UNITS, units);
        }

        // ============================================
        // Validation Functions
        // ============================================
        
        function validateCityInput(city) {
            const trimmed = city.trim();

            if (!trimmed) {
                return { valid: false, error: 'Please enter a city name' };
            }

            if (trimmed.length < 2) {
                return { valid: false, error: 'City name is too short' };
            }

            if (trimmed.length > 100) {
                return { valid: false, error: 'City name is too long' };
            }

            return { valid: true, error: null };
        }

        function showValidationError(message) {
            elements.validationMessage.textContent = message;
            elements.validationMessage.classList.remove('hidden');
        }

        function hideValidationError() {
            elements.validationMessage.classList.add('hidden');
        }

        // ============================================
        // Content State Functions
        // ============================================
        
        function hideAllContent() {
            elements.welcomeMessage.classList.add('hidden');
            elements.loadingSpinner.classList.add('hidden');
            elements.errorContainer.classList.add('hidden');
            elements.weatherCard.classList.add('hidden');
        }

        function showWelcome() {
            hideAllContent();
            elements.welcomeMessage.classList.remove('hidden');
            
            // Clear background effect on welcome
            setBackgroundEffect(null);
        }

        function showLoading() {
            hideAllContent();
            elements.loadingSpinner.classList.remove('hidden');
            
            // Update button state
            elements.searchBtn.disabled = true;
            elements.searchBtnText.classList.add('hidden');
            elements.searchBtnSpinner.classList.remove('hidden');
        }

        function hideLoading() {
            elements.searchBtn.disabled = false;
            elements.searchBtnText.classList.remove('hidden');
            elements.searchBtnSpinner.classList.add('hidden');
        }

        function showError(message) {
            hideAllContent();
            hideLoading();
            elements.errorMessage.textContent = message;
            elements.errorContainer.classList.remove('hidden');
            
            // Clear background effect on error
            setBackgroundEffect(null);
        }

        function showWeatherCard() {
            hideAllContent();
            hideLoading();
            elements.weatherCard.classList.remove('hidden');
        }

        // ============================================
        // Render Functions
        // ============================================
        
        function renderWeatherCard(weather) {
            // Location
            elements.cityName.textContent = `${weather.city}, ${weather.country}`;

            // Temperature
            elements.temperature.textContent = formatTemperature(weather.temperature, weather.units);

            // Feels like
            elements.feelsLike.textContent = `Feels like ${formatTemperature(weather.feels_like, weather.units)}`;

            // Humidity
            elements.humidity.textContent = `${weather.humidity}%`;

            // Wind speed
            elements.windSpeed.textContent = formatWindSpeed(weather.wind_speed, weather.units);

            // Description
            elements.description.textContent = capitalizeFirst(weather.description);

            // Weather icon
            const iconClass = getWeatherIconClass(weather.icon_code);
            const colorClass = getIconColorClass(iconClass);
            
            // Clear previous classes and set new ones
            elements.weatherIcon.className = `wi ${iconClass} ${colorClass} weather-icon-large`;
            elements.weatherIcon.setAttribute('aria-label', weather.description);
            
            // Set background effect based on weather description
            const effect = getBackgroundEffect(weather.description);
            setBackgroundEffect(effect);

            showWeatherCard();
        }

        // ============================================
        // API Functions
        // ============================================
        
        async function fetchWeather(city, units) {
            const url = `/api/v1/weather?city=${encodeURIComponent(city)}&units=${units}`;

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    let errorMessage = 'Something went wrong. Please try again.';

                    try {
                        const errorData = await response.json();
                        
                        if (response.status === 404) {
                            errorMessage = errorData.detail || 'City not found. Please check the spelling and try again.';
                        } else if (response.status === 429) {
                            errorMessage = 'Too many requests. Please wait a moment and try again.';
                        } else if (response.status === 502) {
                            errorMessage = 'Weather service is temporarily unavailable. Please try again later.';
                        } else if (errorData.detail) {
                            errorMessage = errorData.detail;
                        }
                    } catch {
                        // JSON parsing failed, use default message
                    }

                    throw new Error(errorMessage);
                }

                return await response.json();
            } catch (error) {
                if (error instanceof TypeError) {
                    // Network error
                    throw new Error('Unable to connect. Please check your internet connection.');
                }
                throw error;
            }
        }

        // T008: Fetch weather by coordinates
        async function fetchWeatherByCoords(lat, lon, units) {
            const url = `/api/v1/weather?lat=${lat}&lon=${lon}&units=${units}`;

            try {
                const response = await fetch(url);

                if (!response.ok) {
                    let errorMessage = 'Unable to get weather for your location.';

                    try {
                        const errorData = await response.json();
                        
                        if (response.status === 404) {
                            errorMessage = 'Weather data not available for your location.';
                        } else if (response.status === 429) {
                            errorMessage = 'Too many requests. Please wait a moment and try again.';
                        } else if (errorData.detail) {
                            errorMessage = errorData.detail;
                        }
                    } catch {
                        // JSON parsing failed, use default message
                    }

                    throw new Error(errorMessage);
                }

                return await response.json();
            } catch (error) {
                if (error instanceof TypeError) {
                    throw new Error('Unable to connect. Please check your internet connection.');
                }
                throw error;
            }
        }

        // ============================================
        // Event Handlers
        // ============================================
        
        async function handleSearch(event) {
            event.preventDefault();
            hideValidationError();

            const city = elements.cityInput.value;
            const validation = validateCityInput(city);

            if (!validation.valid) {
                showValidationError(validation.error);
                return;
            }

            state.city = city.trim();
            state.loading = true;
            showLoading();

            try {
                const weather = await fetchWeather(state.city, state.units);
                state.weather = weather;
                state.error = null;
                renderWeatherCard(weather);
            } catch (error) {
                state.error = error.message;
                state.weather = null;
                showError(error.message);
            } finally {
                state.loading = false;
            }
        }

        async function handleUnitChange(newUnits) {
            if (newUnits === state.units) return;

            state.units = newUnits;
            saveUnits(newUnits);
            updateToggleUI();

            // Re-fetch weather if we have a city
            if (state.city && state.weather) {
                state.loading = true;
                showLoading();

                try {
                    const weather = await fetchWeather(state.city, state.units);
                    state.weather = weather;
                    state.error = null;
                    renderWeatherCard(weather);
                } catch (error) {
                    state.error = error.message;
                    showError(error.message);
                } finally {
                    state.loading = false;
                }
            }
        }

        function updateToggleUI() {
            const activeClasses = ['bg-blue-500', 'text-white'];
            const inactiveClasses = ['bg-white', 'text-gray-700', 'hover:bg-gray-50'];

            if (state.units === 'metric') {
                // Metric active
                elements.unitMetric.classList.remove(...inactiveClasses);
                elements.unitMetric.classList.add(...activeClasses);
                elements.unitMetric.setAttribute('aria-pressed', 'true');

                // Imperial inactive
                elements.unitImperial.classList.remove(...activeClasses);
                elements.unitImperial.classList.add(...inactiveClasses);
                elements.unitImperial.setAttribute('aria-pressed', 'false');
            } else {
                // Imperial active
                elements.unitImperial.classList.remove(...inactiveClasses);
                elements.unitImperial.classList.add(...activeClasses);
                elements.unitImperial.setAttribute('aria-pressed', 'true');

                // Metric inactive
                elements.unitMetric.classList.remove(...activeClasses);
                elements.unitMetric.classList.add(...inactiveClasses);
                elements.unitMetric.setAttribute('aria-pressed', 'false');
            }
        }

        // ============================================
        // Input Handling
        // ============================================
        
        function handleInputChange() {
            hideValidationError();
        }
        
        // ============================================
        // Geolocation Functions (T007, T009)
        // ============================================
        
        /**
         * Handle geolocation error codes
         */
        function handleGeolocationError(error) {
            let errorMessage = 'Unable to get your location.';
            
            switch (error.code) {
                case 1: // PERMISSION_DENIED
                    errorMessage = 'Location permission denied. Please enable location access in your browser settings and try again.';
                    break;
                case 2: // POSITION_UNAVAILABLE
                    errorMessage = 'Location information is unavailable. Please try again or enter a city name manually.';
                    break;
                case 3: // TIMEOUT
                    errorMessage = 'Location request timed out. Please try again or enter a city name manually.';
                    break;
                default:
                    errorMessage = 'An unknown error occurred while getting your location. Please try entering a city name manually.';
            }
            
            showError(errorMessage);
            state.geolocating = false;
            hideGeolocationLoading();
        }
        
        /**
         * Show loading state for geolocation button
         */
        function showGeolocationLoading() {
            elements.locationBtn.disabled = true;
            elements.searchBtn.disabled = true;
            elements.cityInput.disabled = true;
            elements.locationBtnIcon.classList.add('hidden');
            elements.locationBtnSpinner.classList.remove('hidden');
            showLoading();
        }
        
        /**
         * Hide loading state for geolocation button
         */
        function hideGeolocationLoading() {
            elements.locationBtn.disabled = false;
            elements.searchBtn.disabled = false;
            elements.cityInput.disabled = false;
            elements.locationBtnIcon.classList.remove('hidden');
            elements.locationBtnSpinner.classList.add('hidden');
            hideLoading();
        }
        
        /**
         * Handle geolocation button click (T007)
         */
        async function handleGeolocation() {
            // Check if geolocation is supported
            if (!navigator.geolocation) {
                showError('Geolocation is not supported by your browser. Please enter a city name manually.');
                return;
            }
            
            state.geolocating = true;
            hideValidationError();
            showGeolocationLoading();
            
            // Get current position with 10 second timeout
            navigator.geolocation.getCurrentPosition(
                async (position) => {
                    try {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        // Fetch weather using coordinates
                        const weather = await fetchWeatherByCoords(lat, lon, state.units);
                        
                        // Update state and UI
                        state.weather = weather;
                        state.city = weather.city;
                        state.error = null;
                        
                        // Update city input with detected location
                        elements.cityInput.value = weather.city;
                        
                        // Render weather card
                        renderWeatherCard(weather);
                    } catch (error) {
                        state.error = error.message;
                        state.weather = null;
                        showError(error.message);
                    } finally {
                        state.geolocating = false;
                        hideGeolocationLoading();
                    }
                },
                handleGeolocationError,
                {
                    timeout: 10000,
                    enableHighAccuracy: true,
                    maximumAge: 0
                }
            );
        }
        
        // ============================================
        // Hash Routing (T013)
        // ============================================
        
        /**
         * Handle hash changes for navigation
         */
        function handleHashChange() {
            const hash = window.location.hash.slice(1); // Remove the '#'
            
            if (hash === 'help') {
                showHelpView();
            } else {
                showWeatherView();
            }
        }

        // ============================================
        // Initialization
        // ============================================
        
        function init() {
            // Load stored preferences
            state.units = getStoredUnits();
            updateToggleUI();
            
            // Render help content (T016)
            renderQuickTips();
            renderFAQ();

            // Event listeners
            elements.searchForm.addEventListener('submit', handleSearch);
            elements.cityInput.addEventListener('input', handleInputChange);

            elements.unitMetric.addEventListener('click', () => handleUnitChange('metric'));
            elements.unitImperial.addEventListener('click', () => handleUnitChange('imperial'));
            
            // Help navigation event listeners (T014)
            elements.helpBtn.addEventListener('click', showHelpView);
            elements.backToWeatherBtn.addEventListener('click', showWeatherView);
            
            // Geolocation button event listener (T010)
            elements.locationBtn.addEventListener('click', handleGeolocation);
            
            // Hash routing (T013)
            window.addEventListener('hashchange', handleHashChange);
            
            // Check initial hash on load and set focus accordingly
            handleHashChange();
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
